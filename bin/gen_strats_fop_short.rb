@project = '<?xml version="1.0" encoding="ISO-8859-1"?>
<AmiBroker-Analysis CompactMode="0">
<General>
<FormatVersion>1</FormatVersion>
<Symbol>@FV#C</Symbol>
<FormulaPath>Formulas\\Signals\\PROJECT_AFL.afl</FormulaPath>
FORMULA_CONTENT
<ApplyTo>2</ApplyTo>
<RangeType>1</RangeType>
<RangeAmount>1</RangeAmount>
<FromDate>1/1/2012 00:00:00</FromDate>
<ToDate>1/1/2013</ToDate>
<SyncOnSelect>0</SyncOnSelect>
<RunEvery>0</RunEvery>
<RunEveryInterval>5min</RunEveryInterval>
<IncludeFilter>
<ExcludeMode>0</ExcludeMode>
<MarketID>-1</MarketID>
<GroupID>-1</GroupID>
<SectorID>-1</SectorID>
<IndustryID>-1</IndustryID>
<WatchListID>WATCHLIST</WatchListID>
<Favourite>0</Favourite>
<Index>0</Index>
<GICSID>-1</GICSID>
<ICBID>-1</ICBID>
</IncludeFilter>
<ExcludeFilter>
<ExcludeMode>1</ExcludeMode>
<MarketID>-1</MarketID>
<GroupID>-1</GroupID>
<SectorID>-1</SectorID>
<IndustryID>-1</IndustryID>
<WatchListID>-1</WatchListID>
<Favourite>0</Favourite>
<Index>0</Index>
<GICSID>-1</GICSID>
<ICBID>-1</ICBID>
</ExcludeFilter>
</General>
<BacktestSettings>
<InitialEquity>10000</InitialEquity>
<TradeFlags>3</TradeFlags>
<MaxLossStopMode>0</MaxLossStopMode>
<MaxLossStopValue>0</MaxLossStopValue>
<MaxLossStopAtStop>0</MaxLossStopAtStop>
<ProfitStopMode>0</ProfitStopMode>
<ProfitStopValue>0</ProfitStopValue>
<ProfitStopAtStop>0</ProfitStopAtStop>
<TrailingStopMode>0</TrailingStopMode>
<TrailingStopPeriods>0</TrailingStopPeriods>
<TrailingStopValue>0</TrailingStopValue>
<TrailingStopAtStop>0</TrailingStopAtStop>
<CommissionMode>3</CommissionMode>
<CommissionValue>2.15</CommissionValue>
<BuyPriceField>0</BuyPriceField>
<BuyDelay>0</BuyDelay>
<SellPriceField>0</SellPriceField>
<SellDelay>0</SellDelay>
<ShortPriceField>0</ShortPriceField>
<ShortDelay>0</ShortDelay>
<CoverPriceField>0</CoverPriceField>
<CoverDelay>0</CoverDelay>
<ReportSystemFormula>0</ReportSystemFormula>
<ReportSystemSettings>0</ReportSystemSettings>
<ReportOverallSummary>1</ReportOverallSummary>
<ReportSummary>1</ReportSummary>
<ReportTradeList>1</ReportTradeList>
<LoadRemainingQuotes>1</LoadRemainingQuotes>
<Periodicity>2</Periodicity>
<InterestRate>0</InterestRate>
<ReportOutPositions>1</ReportOutPositions>
<UseConstantPriceArrays>0</UseConstantPriceArrays>
<PointsOnlyTest>1</PointsOnlyTest>
<AllowShrinkingPosition>0</AllowShrinkingPosition>
<RangeType>3</RangeType>
<RangeLength>0</RangeLength>
<RangeFromDate>1/2/2013 00:00:00</RangeFromDate>
<RangeToDate>4/1/2013</RangeToDate>
<ApplyTo>2</ApplyTo>
<FilterQty>2</FilterQty>
<IncludeFilter>
<ExcludeMode>0</ExcludeMode>
<MarketID>-1</MarketID>
<GroupID>-1</GroupID>
<SectorID>-1</SectorID>
<IndustryID>-1</IndustryID>
<WatchListID>WATCHLIST</WatchListID>
<Favourite>0</Favourite>
<Index>0</Index>
<GICSID>-1</GICSID>
<ICBID>-1</ICBID>
</IncludeFilter>
<ExcludeFilter>
<ExcludeMode>1</ExcludeMode>
<MarketID>-1</MarketID>
<GroupID>-1</GroupID>
<SectorID>-1</SectorID>
<IndustryID>-1</IndustryID>
<WatchListID>-1</WatchListID>
<Favourite>0</Favourite>
<Index>0</Index>
<GICSID>-1</GICSID>
<ICBID>-1</ICBID>
</ExcludeFilter>
<UseOptimizedEvaluation>0</UseOptimizedEvaluation>
<BacktestRangeType>3</BacktestRangeType>
<BacktestRangeLength>6</BacktestRangeLength>
<BacktestRangeFromDate>1/1/2009 00:00:00</BacktestRangeFromDate>
<BacktestRangeToDate>1/1/2010</BacktestRangeToDate>
<MarginRequirement>100</MarginRequirement>
<SameDayStops>0</SameDayStops>
<RoundLotSize>1</RoundLotSize>
<TickSize>0</TickSize>
<DrawdownPriceField>0</DrawdownPriceField>
<ReverseSignalForcesExit>0</ReverseSignalForcesExit>
<NoDefaultColumns>0</NoDefaultColumns>
<AllowSameBarExit>0</AllowSameBarExit>
<ExtensiveOptimizationWarning>0</ExtensiveOptimizationWarning>
<WaitForBackfill>0</WaitForBackfill>
<MaxRanked>4</MaxRanked>
<MaxTraded>1</MaxTraded>
<MaxTracked>100</MaxTracked>
<PortfolioReportMode>0</PortfolioReportMode>
<MinShares>1</MinShares>
<SharpeRiskFreeReturn>5</SharpeRiskFreeReturn>
<PortfolioMode>0</PortfolioMode>
<PriceBoundCheck>1</PriceBoundCheck>
<AlignToReferenceSymbol>0</AlignToReferenceSymbol>
<ReferenceSymbol>^DJI</ReferenceSymbol>
<UPIRiskFreeReturn>5.4</UPIRiskFreeReturn>
<NBarStopMode>0</NBarStopMode>
<NBarStopValue>0</NBarStopValue>
<NBarStopReentryDelay>0</NBarStopReentryDelay>
<MaxLossStopReentryDelay>0</MaxLossStopReentryDelay>
<ProfitStopReentryDelay>0</ProfitStopReentryDelay>
<TrailingStopReentryDelay>0</TrailingStopReentryDelay>
<AddFutureBars>0</AddFutureBars>
<DistChartSpacing>5</DistChartSpacing>
<ProfitDistribution>1</ProfitDistribution>
<MAFEDistribution>1</MAFEDistribution>
<IndividualDetailedReports>0</IndividualDetailedReports>
<PortfolioReportTradeList>1</PortfolioReportTradeList>
<LimitTradeSizeAsPctVol>10</LimitTradeSizeAsPctVol>
<DisableSizeLimitWhenVolumeIsZero>1</DisableSizeLimitWhenVolumeIsZero>
<UsePrevBarEquityForPosSizing>0</UsePrevBarEquityForPosSizing>
<NBarStopHasPriority>0</NBarStopHasPriority>
<UseCustomBacktestProc>0</UseCustomBacktestProc>
<CustomBacktestProcFormulaPath>C:\Program Files\AmiBroker\Formulas\Custom\expectancy.afl</CustomBacktestProcFormulaPath>
<MinPosValue>1</MinPosValue>
<MaxPosValue>0</MaxPosValue>
<ChartInterval>3600</ChartInterval>
<DisableRuinStop>0</DisableRuinStop>
<OptTarget>K-Ratio</OptTarget>
<WFMode>1</WFMode>
<GenerateReport>0</GenerateReport>
<MaxLongPos>0</MaxLongPos>
<MaxShortPos>0</MaxShortPos>
<SeparateLongShortRank>0</SeparateLongShortRank>
<TotalSymbolQty>1</TotalSymbolQty>
<EnableUserReportCharts>1</EnableUserReportCharts>
<ChartWidth>500</ChartWidth>
<ChartHeight>300</ChartHeight>
<SettlementDelay>0</SettlementDelay>
</BacktestSettings>
</AmiBroker-Analysis>
'

SPREAD_STRATEGIES = {
  'MA' => 'Cross( spread, MA(spread,lookback) )',
  'CH' => 'spread >= HHV( spread, lookback )',
  'MACT' => 'Cross( MA(spread,lookback), spread )',
  'CHCT' => 'spread <= LLV( spread, lookback )',
}

strategies = {
  'VIX_RSI' => 'Cross( Optimize("vix rsi",90,90,50,2), RSIa(Foreign("@VX#C"),lookback), )',
  'RSI' => 'Cross( Optimize("rsi",50,50,90,2), RSIa(C,lookback) ) ',
  'CH' =>  'C <= LLV(C,lookback) && Sum(C <= LLV(C,lookback),lookback) <= 1',
}

@afl = %Q{
#include <z_score.afl>

OptimizerSetEngine("cmae");
SetOption("FuturesMode", True );
SetBarsRequired(10000, 0);
SetTradeDelays(0,0,0,0);
BuyPrice = SellPrice = C;
SetPositionSize(1, spsShares);
RoundLotSize = 1;

premium = MarginDeposit;
pt = (premium/PointValue) * Optimize("pt",2,1.25,2.5,0.25);
spread = RelStrength("SYMBOL");
lookback = Optimize("lb",10,2,10,1);

Short = ENTRY;
Buy = Sell = Cover = False;

ApplyStop(stopTypeProfit, stopModePoint, pt, 0);
ApplyStop(stopTypeNBar, stopModeBars, 3, 0);

// Optimisations from WFA

AddTextColumn("BUY", "Entry" );
sl = 1;
PositionScore = 1;
#include <entry_signals.afl>
}

WATCH_LIST = {
  '@ES#C' => 1,
  'BD#C' => 2,
  '@AD#C' => 3,
  '@DX#C' => 4,
  '@BP#C' => 5,
  '@CD#C' => 6,
  '@S#C' => 7,
  '@TY#C' => 8,
  '@SM#C' => 9,
  '@BO#C' => 10,
  '@W#C' => 11,
  '@C#C' => 12,
  '@NQ#C' => 13,
  '@FV#C' => 18,
  '@EMD#C' => 19,
  '@YM#C' => 20
}

def afl_code(entry, spread=nil)
  afl_code = @afl.gsub /ENTRY/, entry
  if spread
    afl_code.gsub! /SYMBOL/, spread
  else
    afl_code.gsub! /^.*SYMBOL.*$/, ''
  end
  afl_code
end

def embedded_afl_code(entry, spread=nil)
  afl_code(entry, spread).
    gsub(/&/,'&amp;').
    gsub(/\</,'&lt;').
    gsub(/\>/,'&gt;').
    gsub("\\", "\\\\\\\\").
    gsub(/\n/, '\r\n')
end

def afl_filename(code, spread, bond, entry='S', extension='.afl')
  [ bond, code, spread, entry ].compact.
    map {|_| _.gsub(/(\W|C$)/,'') }.join('_') + extension
end

def project_code(code, entry, spread, bond)
  formula_content = '<FormulaContent>' + embedded_afl_code(entry, spread) + '</FormulaContent>'
  formula_content.gsub! "\\", "\\\\\\\\"
  
  @project.
    gsub(/PROJECT_AFL/, afl_filename(code,spread,bond)).
    gsub(/\<WatchListID\>WATCHLIST<\/WatchListID>/,
      "<WatchListID>#{WATCH_LIST[bond]}</WatchListID>").
    gsub(/FORMULA_CONTENT/, formula_content).
    gsub /<FormulaPath>.*<\/FormulaPath>/,
      "<FormulaPath>Formulas\\\\\\Signals\\\\\\#{afl_filename(code,spread,bond)}</FormulaPath>"
end

def create_spread_strategy(code, entry, spread, bond)
  return if spread == bond
  afl_file = afl_filename(code,spread,bond)
  project_file = afl_filename(code,spread,bond, 'S', '.apx')
  File.open(afl_file,'w') {|_| _.puts afl_code(entry, spread) }
  File.open(project_file,'w') {|_| _.puts project_code(code, entry, spread, bond) }
end

def create_strategy(code, entry, bond)
  afl_file = afl_filename code, nil, bond
  project_file = afl_filename code, nil, bond, 'S', '.apx'
  File.open(afl_file,'w') {|_| _.puts afl_code entry }
  File.open(project_file,'w') {|_| _.puts project_code(code, entry, nil, bond) }
end

def spread_strats(contract,markets)
  markets.each do |spread|
    SPREAD_STRATEGIES.each do |code, entry|
      create_spread_strategy code, entry, spread, contract
    end
  end
end

tradeable_contracts = %w[
  @FV#C
  @ES#C
  @EMD#C
  @YM#C
  @NQ#C
  @AD#C
  @BP#C
  @CD#C
  @S#C
  @C#C
  @DX#C
]

strategies.each do |code, entry|
  tradeable_contracts.each {|_| create_strategy code, entry, _ }
end